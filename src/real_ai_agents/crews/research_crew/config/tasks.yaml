# Research Crew Tasks - Sequential: Scrape → Extract → Validate → Report

scrape_listings:
  description: >
    Search for properties matching: {search_criteria}.

    STEP 1 - SEARCH:
    Use web search to find "{search_criteria}" (e.g., "2 bedroom flats for rent in Lagos").
    Identify 2-4 real estate platform websites from the search results that show 
    property listings for this location (e.g., propertypro.ng, nigeriapropertycentre.com,
    zillow.com, realtor.com - whatever is relevant for the location).

    STEP 2 - VISIT PLATFORM PAGES:
    Click into the most promising platform pages from the search results.
    These pages typically show multiple properties on a single page.

    STEP 3 - COLLECT INDIVIDUAL PROPERTY LINKS:
    From each platform page, collect the direct URL link to each individual 
    property listing that appears to match the user's criteria.
    Collect up to 15 property links total across all platforms.

    RULES:
    - Stop after collecting 15 property sure links maximum
    - Only collect links to individual property pages, not search result pages
    - Include the platform name for each link
    - If a platform blocks you, skip it and try the next one
  expected_output: >
    A JSON object with the collected property links:
    {
      "search_criteria": "{search_criteria}",
      "platforms_used": ["Platform A", "Platform B"],
      "property_links": [
        {
          "url": "https://example.com/property/12345",
          "platform": "Platform A",
          "brief_title": "2 Bed Flat in Lekki"
        }
      ],
      "total_links": 15
    }
  agent: scraper
  tool_choice: required

extract_property_data:
  description: >
    You have a list of individual property URLs from the previous task.

    For EACH property URL, use the TinyFish Web Extractor tool to visit the page 
    and extract the following details:

    REQUIRED FIELDS TO EXTRACT:
    - property_title: The listing headline
    - property_type: flat, apartment, house, duplex, studio, etc.
    - price: The rent or sale price with currency
    - bedrooms: Number of bedrooms
    - bathrooms: Number of bathrooms
    - location: Full address or area description
    - property_description: The full listing description
    - image_urls: All property image URLs found on the page
    - agent_name: The listing agent or property owner name
    - phone_number: Contact phone number
    - property_url: The original URL you visited

    INSTRUCTIONS:
    - Call the TinyFish tool once per property URL
    - Set the goal to: "Extract property details including title, price, bedrooms, 
      bathrooms, location, description, all image URLs, agent name, and phone number"
    - Enable stealth mode (use_stealth=true) for bot-protected sites
    - If a page fails to load, note it and move to the next property
    - After extraction, CHECK if each property matches the user's original 
      criteria: {search_criteria}. Drop any that clearly do not match.
    - Do NOT invent or guess any data. If a field is missing, set it to null.
  expected_output: >
    A JSON array of extracted properties that match the criteria:
    [
      {
        "property_title": "Spacious 2 Bedroom Flat",
        "property_type": "flat",
        "price": "₦1,500,000/year",
        "bedrooms": 2,
        "bathrooms": 2,
        "location": "Lekki Phase 1, Lagos",
        "property_description": "A well-finished 2 bedroom flat...",
        "image_urls": ["https://...", "https://..."],
        "agent_name": "John Properties",
        "phone_number": "+234-801-234-5678",
        "property_url": "https://example.com/property/12345",
        "matches_criteria": true
      }
    ]
  agent: tinyfish_extractor
  tool_choice: required
  context:
    - scrape_listings

validate_data:
  description: >
    Validate the extracted property records for data quality.

    FOR EACH PROPERTY CHECK:
    1. Has a price (any format, must exist)
    2. Has a location (at minimum an area or city)
    3. Has at least one contact method (phone number OR agent name)
    4. Phone number format is valid if present (7+ digits)
    5. URLs start with http:// or https://
    6. Has at least one image URL

    SCORING (0-100):
    - 100: All fields present and valid
    - 80-99: Minor gaps (missing optional fields like bathrooms)
    - 60-79: Some issues (missing 1-2 important fields)
    - 40-59: Significant gaps (no images or no description)
    - Below 40: Missing critical fields (no price or no location)

    IMPORTANT: Do NOT remove properties. Flag issues and let the human decide.
  expected_output: >
    A JSON array of validated properties, each with added fields:
    - quality_score: Integer 0-100
    - validation_issues: Array of specific problems found
    - is_actionable: true if enough data exists to contact the agent

    Plus a summary:
    - total_properties: count
    - average_quality: average score
    - properties_with_issues: count
  agent: validator
  context:
    - extract_property_data

compile_research_report:
  description: >
    Compile all validated properties into a final JSON report for the user.

    REPORT STRUCTURE:
    1. METADATA:
       - search_criteria: What the user searched for
       - generated_at: Current timestamp
       - total_properties: How many properties found
       - average_quality: Average quality score

    2. PROPERTIES array (sorted by quality_score, highest first):
       Each property must include:
       - id: "prop_001", "prop_002", etc.
       - property_title: Clean display title
       - price: Formatted with currency
       - location: Clean address
       - bedrooms and bathrooms
       - property_type
       - primary_image: First image URL
       - all_images: Array of all image URLs
       - agent_name: Contact person
       - phone_number: Contact phone
       - property_url: Link to original listing
       - quality_score: From validation
       - issues: Any flagged problems

    FORMAT RULES:
    - Use snake_case for all field names
    - Use empty arrays [] instead of null for missing lists
    - Include currency symbols in prices
  expected_output: >
    A single JSON object:
    {
      "metadata": {
        "search_criteria": "2 bedroom flats in Lagos",
        "generated_at": "2026-02-24T12:00:00Z",
        "total_properties": 5,
        "average_quality": 82
      },
      "properties": [
        {
          "id": "prop_001",
          "property_title": "Spacious 2 Bed Flat in Lekki",
          "price": "₦1,500,000/year",
          "location": "Lekki Phase 1, Lagos",
          "bedrooms": 2,
          "bathrooms": 2,
          "property_type": "flat",
          "primary_image": "https://...",
          "all_images": ["https://..."],
          "agent_name": "John Properties",
          "phone_number": "+234-801-234-5678",
          "property_url": "https://example.com/...",
          "quality_score": 95,
          "issues": []
        }
      ]
    }
  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
